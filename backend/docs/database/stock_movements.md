# ğŸ—‚ Table: stock_movements

---

ÎšÎ±Ï„Î±Î³ÏÎ¬Ï†ÎµÎ¹ **ÎºÎ¬Î¸Îµ Î±Î»Î»Î±Î³Î® ÏƒÏ„Î¿ Î±Ï€ÏŒÎ¸ÎµÎ¼Î±** ÎµÎ½ÏŒÏ‚ product variant Î¼Î­ÏƒÎ± ÏƒÎµ Î­Î½Î± store.  
Î‘Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï„Î¿Î½ Ï€Î¹Î¿ ÎºÏÎ¯ÏƒÎ¹Î¼Î¿ Ï€Î¯Î½Î±ÎºÎ± Î³Î¹Î± inventory accuracy, ÎºÎ±Î¸ÏÏ‚ ÏŒÎ»ÎµÏ‚ Î¿Î¹ Î±Ï…Î¾Î¿Î¼ÎµÎ¹ÏÏƒÎµÎ¹Ï‚ (ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½ÎµÏ‚, ÎµÎ¾ÎµÏÏ‡ÏŒÎ¼ÎµÎ½ÎµÏ‚, Î¼ÎµÏ„Î±Ï†Î¿ÏÎ­Ï‚, Î´Î¹Î¿ÏÎ¸ÏÏƒÎµÎ¹Ï‚) Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Ï€ÎµÏÎ½Î¿ÏÎ½ Î±Ï€ÏŒ ÎµÎ´Ï.

ÎšÎ¬Î¸Îµ ÎºÎ¯Î½Î·ÏƒÎ· Î­Ï‡ÎµÎ¹ ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· (`IN` Î® `OUT`), Ï€Î¿ÏƒÏŒÏ„Î·Ï„Î±, Î±Î¹Ï„Î¯Î±/Ï„ÏÏ€Î¿ ÎºÎ¯Î½Î·ÏƒÎ·Ï‚ ÎºÎ±Î¹ Î±Î½Î±Ï†Î¿ÏÎ¬ ÏƒÏ„Î¿ related document (sale, purchase, transfer Îº.Î»Ï€.).

**Works with:**
- `companies` â†’ Î· ÎµÏ„Î±Î¹ÏÎµÎ¯Î± ÏƒÏ„Î·Î½ Î¿Ï€Î¿Î¯Î± Î±Î½Î®ÎºÎµÎ¹ Î· ÎºÎ¯Î½Î·ÏƒÎ·
- `stores` â†’ Ï„Î¿ store ÏŒÏ€Î¿Ï… Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ Î±Ï€ÏŒÎ¸ÎµÎ¼Î±
- `product_variants` â†’ Ï€Î¿Î¹Î¿ variant ÎµÏ€Î·ÏÎµÎ¬Î¶ÎµÏ„Î±Î¹
- `store_products` â†’ ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Ï„Ï‰Î½ quantities Î±Î½Î¬ variant & store
- `sales` â†’ Î¿Î¹ Ï€Ï‰Î»Î®ÏƒÎµÎ¹Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ½ OUT ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚
- `sale_items` â†’ Î³ÏÎ±Î¼Î¼Î­Ï‚ Ï€ÏÎ»Î·ÏƒÎ·Ï‚ Ï€Î¿Ï… Ï€Î±ÏÎ¬Î³Î¿Ï…Î½ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚
- `purchases` â†’ Î¿Î¹ Î±Î³Î¿ÏÎ­Ï‚ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ½ IN ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚
- `purchase_items` â†’ Î³ÏÎ±Î¼Î¼Î­Ï‚ Î±Î³Î¿ÏÎ¬Ï‚ Ï€Î¿Ï… Ï€Î±ÏÎ¬Î³Î¿Ï…Î½ ÎµÎ¹ÏƒÎµÏÏ‡ÏŒÎ¼ÎµÎ½Î± stock
- `users` â†’ Ï€Î¿Î¹Î¿Ï‚ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Ï€ÏÎ±Î³Î¼Î±Ï„Î¿Ï€Î¿Î¯Î·ÏƒÎµ Ï„Î·Î½ ÎºÎ¯Î½Î·ÏƒÎ· (ÏŒÏ€Î¿Ï… ÎµÏ†Î±ÏÎ¼ÏŒÎ¶ÎµÏ„Î±Î¹)
- `plugins` (Î­Î¼Î¼ÎµÏƒÎ±) â†’ plugins ÏŒÏ€Ï‰Ï‚ fuel_station Î¼Ï€Î¿ÏÎ¿ÏÎ½ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î¿ÏÎ½ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î±

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î±:
- Î±ÎºÏÎ¹Î²Î® ÎµÎ½Î·Î¼Î­ÏÏ‰ÏƒÎ· Î±Ï€Î¿Î¸Î­Î¼Î±Ï„Î¿Ï‚,
- auditing (Ï€Î¿Î¹Î¿Ï‚ Î¬Î»Î»Î±Î¾Îµ Ï„Î¹ ÎºÎ±Î¹ Ï€ÏŒÏ„Îµ),
- reconstruction Ï„Î¿Ï… Î¹ÏƒÏ„Î¿ÏÎ¹ÎºÎ¿Ï Î±Ï€Î¿Î¸Î®ÎºÎ·Ï‚ (inventory timeline),
- reports Î±Ï€Î¿Î¸ÎµÎ¼Î¬Ï„Ï‰Î½ ÎºÎ±Î¹ ÎºÎ¹Î½Î®ÏƒÎµÏ‰Î½,
- Î±Ï…Ï„ÏŒÎ¼Î±Ï„ÎµÏ‚ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚ Î¼Î­ÏƒÏ‰ POS ÎºÎ±Î¹ purchase modules.

ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ **stock_movements** ÎµÎ¯Î½Î±Î¹ Ï„Î¿ Î¸ÎµÎ¼Î­Î»Î¹Î¿ ÎµÎ½ÏŒÏ‚ Î±Î¾Î¹ÏŒÏ€Î¹ÏƒÏ„Î¿Ï… inventory system:  
â€œÎ±Î½ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÎºÎ¯Î½Î·ÏƒÎ· ÎµÎ´Ï, Ï„ÏŒÏ„Îµ Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î±Î»Î»Î±Î³Î® ÏƒÏ„Î¿ Î±Ï€ÏŒÎ¸ÎµÎ¼Î±â€.

---

## ğŸ“Œ 1. Fields Definition

| Field | Type | Null | Default | Description |
|--------|-------------|------|-----------|-------------|
| id (PK) | UUID | NOT NULL | gen_random_uuid() | Unique stock movement identifier |
| company_id (FK) | UUID | NOT NULL | â€” | References companies(id) |
| store_id (FK) | UUID | NOT NULL | â€” | Store where movement occurred |
| product_id (FK) | INT | NOT NULL | â€” | References products(id) |
| product_variant_id (FK) | INT | NOT NULL | â€” | NULL only if product has no variants |
| quantity | NUMERIC(12,3) | NOT NULL | â€” | Positive = IN, Negative = OUT |
| movement_type | TEXT | NOT NULL | â€” | purchase, sale, refund, adjustment, transfer, plugin |
| source | TEXT | NOT NULL | 'manual' | manual, automated, pump_autosale |
| related_document_id | UUID | NULL | â€” | Linked document ID |
| created_by (FK) | UUID | NULL | â€” | User who triggered it |
| created_at | TIMESTAMP | NOT NULL | NOW() | Timestamp |

---

## ğŸ“Œ 2. Example Rows

| id     | company_id | store_id  | product_id | product_variant_id | quantity | movement_type | source          | related_document_id | created_by | created_at          |
| ------ | ---------- | --------- | ---------- | ------------------ | -------- | ------------- | --------------- | ------------------- | ---------- | ------------------- |
| sm-001 | comp-1111  | store-aaa | 10         | 1                  | 100.000  | purchase    | manual        | pur-100             | user-111   | 2025-01-01 12:00:00 |
| sm-002 | comp-1111  | store-aaa | 10         | 1                  | -3.000   | sale        | manual        | sale-500            | user-111   | 2025-01-05 10:00:01 |
| sm-003 | comp-1111  | store-ccc | 21         | 4                  | -1.000   | sale        | manual        | sale-500            | user-111   | 2025-01-05 10:00:02 |
| sm-004 | comp-2222  | store-bbb | 22         | 5                  | -20.000  | sale        | pump_autosale | sale-004            | NULL       | 2025-01-05 12:30:00 |
| sm-005 | comp-1111  | store-aaa | 10         | 1                  | 2.000    | adjustment  | manual        | NULL                | user-111   | 2025-01-07 09:00:00 |
| sm-006 | comp-1111  | store-bbb | 10         | 1                  | 50.000   | transfer    | manual        | transfer-001        | user-222   | 2025-01-08 12:10:00 |

Î¤Î¿ quantity ÎµÎ¯Î½Î±Î¹ Î¸ÎµÏ„Î¹ÎºÏŒ Î³Î¹Î± IN, Î±ÏÎ½Î·Ï„Î¹ÎºÏŒ Î³Î¹Î± OUT â€” Î±Ï…Ï„ÏŒ Î±Ï€Î»Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î± stock calculations Ï„ÎµÏÎ¬ÏƒÏ„Î¹Î±.

---

## ğŸ“Œ 3. SQL: CREATE TABLE (Supabase)

```sql
CREATE TABLE stock_movements (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,
  product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE RESTRICT,
  product_variant_id BIGINT NOT NULL REFERENCES product_variants(id) ON DELETE RESTRICT,
  quantity NUMERIC(12,3) NOT NULL,
  movement_type TEXT NOT NULL CHECK (movement_type IN ('sale', 'purchase', 'adjustment', 'transfer_in', 'transfer_out', 'return', 'damage', 'recount')),
  source TEXT NOT NULL DEFAULT 'manual' CHECK (source IN ('manual', 'sale', 'purchase', 'transfer', 'adjustment')),
  related_document_id UUID NULL,
  created_by UUID NULL REFERENCES users(id) ON DELETE SET NULL,
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE INDEX idx_stock_movements_company_id ON stock_movements(company_id);
CREATE INDEX idx_stock_movements_store_id ON stock_movements(store_id);
CREATE INDEX idx_stock_movements_product_id ON stock_movements(product_id);
CREATE INDEX idx_stock_movements_variant_id ON stock_movements(product_variant_id);
CREATE INDEX idx_stock_movements_created_at ON stock_movements(created_at DESC);
CREATE INDEX idx_stock_movements_movement_type ON stock_movements(store_id, movement_type);
CREATE INDEX idx_stock_movements_document ON stock_movements(related_document_type, related_document_id) WHERE related_document_type IS NOT NULL; --?
```

---

## ğŸ“Œ 4. SQL: Insert Demo Data

```sql
INSERT INTO stock_movements
  (company_id, store_id, product_id, product_variant_id, quantity,
   movement_type, source, related_document_id, created_by)
VALUES
  -- Purchase stock IN
  (
    'comp-1111',
    'store-aaa',
    10,
    1,
    100.000,
    'purchase',
    'manual',
    'pur-100',
    'user-111'
  ),

  -- Sale stock OUT
  (
    'comp-1111',
    'store-aaa',
    10,
    1,
    -3.000,
    'sale',
    'manual',
    'sale-500',
    'user-111'
  ),

  -- Another sale item
  (
    'comp-1111',
    'store-ccc',
    21,
    4,
    -1.000,
    'sale',
    'manual',
    'sale-500',
    'user-111'
  ),

  -- Automated fuel sale
  (
    'comp-2222',
    'store-bbb',
    22,
    5,
    -20.000,
    'sale',
    'pump_autosale',
    'sale-004',
    NULL
  ),

  -- Manual stock correction (+2 units)
  (
    'comp-1111',
    'store-aaa',
    10,
    1,
    2.000,
    'adjustment',
    'manual',
    NULL,
    'user-111'
  ),

  -- Transfer IN or OUT (depending on sign)
  (
    'comp-1111',
    'store-bbb',
    10,
    1,
    50.000,
    'transfer',
    'manual',
    'transfer-001',
    'user-222'
  );
```
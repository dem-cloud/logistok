# ðŸ—‚ Table: store_products

---

Î‘Î½Ï„Î¹Ï€ÏÎ¿ÏƒÏ‰Ï€ÎµÏÎµÎ¹ Ï„Î¿ **Î±Ï€ÏŒÎ¸ÎµÎ¼Î± (stock)** ÎºÎ¬Î¸Îµ product variant ÏƒÎµ ÎºÎ¬Î¸Îµ store.  
ÎšÎ¬Î¸Îµ row Î´ÎµÎ¯Ï‡Î½ÎµÎ¹ Ï€ÏŒÏƒÎ± Ï„ÎµÎ¼Î¬Ï‡Î¹Î±/ÎºÎ¹Î»Î¬/Î»Î¯Ï„ÏÎ± ÎµÎ½ÏŒÏ‚ ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿Ï… variant Ï…Ï€Î¬ÏÏ‡Î¿Ï…Î½ ÏƒÎµ Î­Î½Î± ÏƒÏ…Î³ÎºÎµÎºÏÎ¹Î¼Î­Î½Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î±.

ÎŸ Ï€Î¯Î½Î±ÎºÎ±Ï‚ Î´ÎµÎ½ Î´Î·Î¼Î¹Î¿Ï…ÏÎ³ÎµÎ¯ ÎºÎ¹Î½Î®ÏƒÎµÎ¹Ï‚Â· ÎµÎ½Î·Î¼ÎµÏÏŽÎ½ÎµÏ„Î±Î¹ Ï€Î¬Î½Ï„Î± Î¼Î­ÏƒÏ‰ Ï„Î¿Ï… `stock_movements`.

**Works with:**
- `stores` â†’ Ï„Î¿ ÎºÎ±Ï„Î¬ÏƒÏ„Î·Î¼Î± ÏƒÏ„Î¿ Î¿Ï€Î¿Î¯Î¿ Î±Î½Î®ÎºÎµÎ¹ Ï„Î¿ stock
- `product_variants` â†’ Ï„Î¿ variant Ï€Î¿Ï… Ï€Î±ÏÎ±ÎºÎ¿Î»Î¿Ï…Î¸ÎµÎ¯Ï„Î±Î¹
- `companies` (Î­Î¼Î¼ÎµÏƒÎ±) â†’ Î¼Î­ÏƒÏ‰ store â†’ company
- `stock_movements` â†’ Î¿ Î¼Î¿Î½Î±Î´Î¹ÎºÏŒÏ‚ Ï„ÏÏŒÏ€Î¿Ï‚ Î¼Îµ Ï„Î¿Î½ Î¿Ï€Î¿Î¯Î¿ Î±Î»Î»Î¬Î¶ÎµÎ¹ Ï„Î¿ quantity
- `sales` / `sale_items` â†’ Î¼ÎµÎ¹ÏŽÎ½Î¿Ï…Î½ stock
- `purchases` / `purchase_items` â†’ Î±Ï…Î¾Î¬Î½Î¿Ï…Î½ stock
- `plugins` (Î­Î¼Î¼ÎµÏƒÎ±) â†’ plugins ÏŒÏ€Ï‰Ï‚ fuel_station Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± ÎµÎ½Î·Î¼ÎµÏÏŽÎ½Î¿Ï…Î½ stock Î±Ï…Ï„ÏŒÎ¼Î±Ï„Î±

Î§ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹ Î³Î¹Î±:
- inventory tracking Î±Î½Î¬ store,
- real-time stock levels ÏƒÎµ POS & Î±Ï€Î¿Î¸Î®ÎºÎ·,
- Î±Ï€Î¿Ï†Ï…Î³Î® Î»Î±Î¸ÏŽÎ½ Ï„Î¹Î¼Î¿Î»ÏŒÎ³Î·ÏƒÎ·Ï‚ (negative stock alerts),
- reports Î±Ï€Î¿Î¸ÎµÎ¼Î¬Ï„Ï‰Î½ Î±Î½Î¬ store & variant,
- multi-store Î´Î¹Î±Ï‡ÎµÎ¯ÏÎ¹ÏƒÎ· Ï€ÏÎ¿ÏŠÏŒÎ½Ï„Ï‰Î½.

Î‘Ï€Î¿Ï„ÎµÎ»ÎµÎ¯ Ï„Î¿ **main source of truth** Î³Î¹Î± Ï„Î¿ Ï„ÏÎ­Ï‡Î¿Î½ Î±Ï€ÏŒÎ¸ÎµÎ¼Î± ÎµÎ½ÏŒÏ‚ variant.

---

## ðŸ“Œ 1. Fields Definition

| Field | Type | Null | Default | Description |
|--------|-----------|------|-----------|-------------|
| id (PK) | INT | NOT NULL | AUTO-INCREMENT | Unique store-product record |
| store_id (FK) | UUID | NOT NULL | â€” | References stores(id) |
| product_id (FK) | INT | NOT NULL | â€” | References products(id) |
| product_variant_id (FK) | INT | NOT NULL | â€” | References product_variants(id) |
| stock_quantity | NUMERIC(12,3) | NOT NULL | 0 | Current stock for this store/product/variant |
| store_sale_price | NUMERIC(12,2) | NULL | â€” | Store-specific sale price |
| created_at | TIMESTAMP | NOT NULL | NOW() | Creation timestamp |

---

## â„¹ï¸ Notes

- Represents **current stock and pricing** for each product (or variant) per store.
- Stock is primarily computed from `stock_movements`, but `store_products.quantity` helps with:
  - faster UI loading,
  - offline sync,
  - caching,
  - snapshot reporting.
- `sale_price` can override global product price.

---

## ðŸ“Œ 2. Example Rows

| id | store_id  | product_id | product_variant_id | stock_quantity | store_sale_price | created_at          |
| -- | --------- | ---------- | ------------------ | -------------- | ---------------- | ------------------- |
| 1  | store-aaa | 101        | 1011               | 120.000        | 4.50             | 2025-01-01 09:00:00 |
| 2  | store-aaa | 102        | 1021               | 15.000         | 12.00            | 2025-01-01 09:05:00 |
| 3  | store-bbb | 101        | 1011               | 80.500         | 4.30             | 2025-01-02 10:10:00 |
| 4  | store-bbb | 103        | 1031               | 200.000        | NULL             | 2025-01-02 10:15:00 |

---

## ðŸ“Œ 3. SQL: CREATE TABLE (Supabase)

```sql
CREATE TABLE store_products (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,

  store_id UUID NOT NULL REFERENCES stores(id) ON DELETE CASCADE,

  product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  product_variant_id BIGINT NOT NULL REFERENCES product_variants(id) ON DELETE RESTRICT,

  stock_quantity NUMERIC(12,3) NOT NULL DEFAULT 0,
  store_sale_price NUMERIC(12,2) NULL CHECK (store_sale_price >= 0),

  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);

CREATE UNIQUE INDEX store_products_unique_store_variant
ON store_products (store_id, product_variant_id);

CREATE INDEX idx_store_products_store_id ON store_products(store_id);
CREATE INDEX idx_store_products_product_id ON store_products(product_id);
CREATE INDEX idx_store_products_variant_id ON store_products(product_variant_id);
CREATE INDEX idx_store_products_low_stock ON store_products(store_id) WHERE stock_quantity <= min_stock_level; --?
```

---

## ðŸ“Œ 4. SQL: Insert Demo Data

```sql
INSERT INTO store_products
  (store_id, product_id, product_variant_id, stock_quantity, store_sale_price)
VALUES
  -- Store AAA: Sand 25kg
  (
    'store-aaa',
    101,
    1011,
    120.000,
    4.50
  ),

  -- Store AAA: Cement 50kg
  (
    'store-aaa',
    102,
    1021,
    15.000,
    12.00
  ),

  -- Store BBB: Sand 25kg (different stock and different price)
  (
    'store-bbb',
    101,
    1011,
    80.500,
    4.30
  ),

  -- Store BBB: Gravel 1 Ton (no store-specific price)
  (
    'store-bbb',
    103,
    1031,
    200.000,
    NULL
  );
```
